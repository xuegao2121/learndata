<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>title</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #label {
            position: absolute;
            padding: 10px;
            background: rgba(255, 255, 255, 0.6);
            line-height: 1;
            border-radius: 5px;
        }
    </style>

    <script src="libs/jquery-1.9.1.js"></script>
    <script src="libs/build/three.js"></script>

    <script src="libs/examples/js/Detector.js"></script>
    <script src="libs/examples/js/libs/dat.gui.min.js"></script>
    <script src="libs/examples/js/libs/stats.min.js"></script>

    <script src="libs/examples/js/controls/OrbitControls.js"></script>

    <script src="libs/examples/js/loaders/OBJLoader.js"></script>
    <script src="libs/examples/js/loaders/MTLLoader.js"></script>

</head>
<body>
<div id="WebGL-output"></div>
<div id="Stats-output"></div>
<div id="label"></div>

<script>
    $(function () {
        var stats = initStats();

        var scene, camera, renderer, controls, light, gui, selectObject, labelPlane, fontMesh, bspObject;

        // 初始化场景
        function initScene() {
            scene = new THREE.Scene();
        }

        // 初始化相机
        function initCamera() {
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 40, 40);
            camera.lookAt(new THREE.Vector3(0, 0, 0));
        }

        // 初始化渲染器
        function initRenderer() {
            if (Detector.webgl) {
                renderer = new THREE.WebGLRenderer({
                    antialias: true,
                    autoClear: true
                });
            } else {
                renderer = new THREE.CanvasRenderer();
            }
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x050505);

            $('#WebGL-output').append(renderer.domElement);

        }

        // 初始化控制控件
        function initControls() {

            controls = new THREE.OrbitControls(camera, renderer.domElement);

            controls.minDistance = 10;
            controls.maxDistance = 80;
            controls.maxPolarAngle = Math.PI * 0.5;

        }

        // 初始化灯光
        function initLight() {

            light = new THREE.SpotLight(0xE5E5E5);
            light.position.set(-10, 20, 30);
            light.castShadow = true;

            scene.add(light);
            scene.add(new THREE.AmbientLight(0xffffff));

        }

        // 初始化gui
        function initGui() {

            gui = {};
            var guiControls = new dat.GUI();

        }

        // 加载模型
        function initContent() {

            var mtlLoader = new THREE.MTLLoader();

            mtlLoader.setPath('data/room/');
            mtlLoader.load('room3.mtl', function (materials) {
                var objLoader = new THREE.OBJLoader();

                objLoader.setMaterials(materials);
                objLoader.setPath('data/room/');
                objLoader.load('room3.obj', function (object) {
                    for (let i = 0; i < object.children.length; i++) {
                        var id = object.children[i].id;

                        // id = 125:地板, 94:两侧墙壁
                        if (id == 125 || id == 94) {
                            // 判断是否是网格对象
                            if (object.children[i].isMesh) {
                                object.children[i].receiveShadow = true;
                                for (let j = 0; j < object.children[i].material.length; j++) {
                                    // 设置双面渲染
                                    object.children[i].material[j].side = THREE.DoubleSide;
                                }
                            }
                        }
                    }
                    scene.add(object);
                });
            });

        }

        // 键盘触发的事件
        function onKeyDown(event) {

            // 清除浏览器默认事件
            event.preventDefault();

            switch (event.keyCode) {
                case 13: // Enter 键触发, 重置相机和轨迹控制
                    initCamera();
                    initControls();
                    break;
            }

        }

        // 获取与射线相交的对象数组
        function getIntersects(event, objects) {

            //声明raycaster和mouse变量
            var raycaster = new THREE.Raycaster();
            var mouse = new THREE.Vector2();

            //通过鼠标点击的位置计算出raycaster所需要的点的位置，以屏幕中心为原点，值的范围为-1到1.
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            // 通过鼠标点的位置和当前相机的矩阵计算出raycaster
            raycaster.setFromCamera(mouse, camera);

            // 获取与射线相交的对象数组，其中的元素按照距离排序，越近的越靠前
            var intersects = raycaster.intersectObjects(objects);

            return intersects;

        }

        // 鼠标单击触发的事件
        function onMouseClick(event) {

            event.preventDefault();

            // 获取与射线相交的对象数组
            var intersects = getIntersects(event, scene.children[2].children)

            if (intersects.length > 0 && intersects[0].object.isMesh) {

                // 移除创建的模型
                if (scene.getObjectByName('replaceObject') != null) {
                    scene.remove(scene.getObjectByName('replaceObject'));
                }
                // 新建材质
                var material = new THREE.MeshBasicMaterial({color: 0x9B30FF});
                material.transparent = true;
                material.opacity = 0.6;

                //替换焦点最近的一个物体
                var replaceGeometry = intersects[0].object.geometry;
                var replaceObject = new THREE.Mesh(replaceGeometry, material);
                replaceObject.name = "replaceObject";
                scene.add(replaceObject);
                selectObject = intersects[0].object;

            } else {
                console.log("未选中 Mesh !");
            }

        }

        // 初始化性能插件
        function initStats() {

            var stats = new Stats();

            stats.setMode(0);

            stats.domElement.style.position = 'absolute';
            stats.domElement.style.left = '0px';
            stats.domElement.style.top = '0px';

            $("#Stats-output").append(stats.domElement);

            return stats;

        }

        // 更新div的位置
        function renderDiv(object) {

            if (object != undefined){
                // 获取缓存几何模型的矩阵
                var verticesArray = object.geometry.attributes.position.array;

                // 获取选中对象包围盒属性的 vector3 属性
                var boxVector3 = object.geometry.boundingSphere.center;

                // 获取窗口的一半高度和宽度
                let halfWidth = window.innerWidth / 2;
                let halfHeight = window.innerHeight / 2;

                // 逆转相机求出二维坐标
                let vector = boxVector3.clone().project(camera);

                // 修改 div 的位置
                $("#label").css({
                    left: vector.x * halfWidth + halfWidth,
                    top: -vector.y * halfHeight + halfHeight
                });

                // 显示模型信息
                $("#label").text("id:" + object.id);
            }

        }

        function onWindowResize() {

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);

        }

        function init() {

            initScene();
            initCamera();
            initRenderer();
            initControls();
            initLight();
            initGui();
            initContent();
            window.addEventListener('resize', onWindowResize, false);
            window.addEventListener('click', onMouseClick, false);
            window.addEventListener('keydown', onKeyDown, false);

        }

        function update() {

            stats.update();
            controls.update();
            renderDiv(selectObject);

        }

        function animate() {

            requestAnimationFrame(animate);
            renderer.render(scene, camera);
            update();

        }

        init();
        animate();
    });

</script>
</body>
</html>